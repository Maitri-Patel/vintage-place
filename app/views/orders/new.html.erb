<!-- app/views/orders/new.html.erb -->
<div class="container mt-5">
  <h1 class="mb-4">Review Your Order</h1>

  <% total_price = 0 %>

  <table class="table">
    <thead class="table-light">
      <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody>
      <% @cart_items.each do |product, quantity| %>
        <% subtotal = product.price * quantity %>
        <% total_price += subtotal %>
        <tr>
          <td><%= product.name %></td>
          <td><%= quantity %></td>
          <td><%= number_to_currency(product.price) %></td>
          <td><%= number_to_currency(subtotal) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <!-- Address fields for the order -->
  <% if current_user.address_line1 %>
    <%= fields_for :address, current_user do |addr_form| %>
      <%= addr_form.label :address_line1 %>
      <%= addr_form.text_field :address_line1 %>

      <%= addr_form.label :city %>
      <%= addr_form.text_field :city %>

      <%= addr_form.label :province_id %>
      <%= addr_form.collection_select :province_id, Province.all, :id, :name, include_blank: true %>

      <%= addr_form.label :postal_code %>
      <%= addr_form.text_field :postal_code %>
    <% end %>
  <% end %>

  <p>Subtotal: <%= number_to_currency(@subtotal) %></p>
<p>Estimated Tax: <%= number_to_currency(@estimated_tax) %></p>
<h3>Total: <%= number_to_currency(@subtotal + @estimated_tax) %></h3>


  <div class="d-flex justify-content-between align-items-center mb-4">
    
    <%= button_to 'Place Order', orders_path, method: :post, params: { order: { product_ids: @cart_items.map { |product, quantity| product.id }, quantities: @cart_items.map { |product, quantity| quantity } } }, class: 'btn btn-primary' %>
  </div>


</div>
